FROM docker.io/library/rust:alpine AS build
ARG FEATURES=arti/onion-service-client
ENV RUSTFLAGS="-C target-feature=-crt-static"
ENV CARGO_UNSTABLE_SPARSE_REGISTRY=true
RUN rustup install nightly && rustup default nightly
RUN apk add musl-dev pkgconfig openssl-dev sqlite-dev xz-dev --no-cache
RUN cargo install --features ${FEATURES} arti

FROM docker.io/library/alpine:latest
COPY --from=build /usr/local/cargo/bin/arti /bin/arti
RUN apk -U upgrade --no-cache
RUN apk add xz-libs sqlite-libs openssl libgcc --no-cache
RUN addgroup -S arti && adduser -h /arti -S arti -G arti
USER arti:arti
COPY arti.toml /arti/.config/arti/arti.toml
VOLUME [ "/arti" ]
ENTRYPOINT [ "/bin/arti", "proxy" ]
